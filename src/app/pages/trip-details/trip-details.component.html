
<div *ngIf="!isLoading; else loadingTemplate">

  <div class="bg-[#f4f7fc] min-h-screen font-arabic">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

     <header class="bg-white shadow-lg rounded-2xl p-6 mb-6 mt-6">
    <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
    
        <div class="text-center sm:text-right">
            <p class="text-2xl font-bold text-gray-800" *ngIf="trip">
                {{ trip.departureTime | date:'fullDate' : undefined : 'ar-EG' }}
            </p>
            <div class="flex items-center gap-3 text-gray-700 mt-4" *ngIf="trip">
              <div class="flex items-center gap-2">
                <i class="fas fa-map-marker-alt font-arabic text-[#364E99]"></i>
                <span class="font-arabic">{{ trip.departureCity }}</span>
              </div>
             <i class="fas fa-arrow-left text-gray-400 "></i>
              <div class="flex items-center gap-2">
                <i class="fas fa-flag-checkered font-arabic text-[#0BB097]"></i>
                <span class="font-arabic">{{ trip.destinationCity }}</span>
              </div>
            </div>
        </div>

        <!-- Trip Status -->
        <div class="mt-4 sm:mt-0" *ngIf="trip">
            <div class="px-4 py-2 rounded-full text-base font-bold flex items-center gap-2" [ngClass]="{
                'bg-blue-100 text-blue-800': trip?.status === 1,
                'bg-orange-100 text-orange-800': trip?.status === 2,
                'bg-green-100 text-green-800': trip?.status === 3,
                'bg-red-100 text-red-800': trip?.status === 4
            }">
                <i class="fa-solid fa-circle text-xs"></i>
                <span>
                    {{ trip?.status === 1 ? 'مجدولة' :
                       trip?.status === 2 ? 'جارية الآن' :
                       trip?.status === 3 ? 'مكتملة' :
                       trip?.status === 4 ? 'ملغاة' : 'غير معروفة' }}
                </span>
            </div>
        </div>
    </div>
</header>


      <!-- Main Grid Layout -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Left Column (Main Content) -->
        <div class="lg:col-span-2 space-y-6">

          <!-- Driver Card -->
          <div class="card">
            <div class="flex flex-col sm:flex-row items-center gap-6">
              <img [src]="trip?.driverImageUrl" alt="صورة السائق" class="w-20 h-20 rounded-full border-4 border-[#0BB097]">
              <div class="flex-grow sm:text-right">
                <h3 class="text-2xl font-bold text-gray-900">{{ trip?.driverName || 'لا يوجد' }}</h3>
                <div class="flex items-center justify-center sm:justify-start gap-4 mt-2 text-sm text-gray-600">
                  <!-- <div class="flex items-center gap-2 text-green-600"><span>نادرا ما يتم إلغاء الرحلات</span></div> -->
                  <div class="flex items-center gap-2  text-green-600"><i class="fas fa-shield-alt"></i><span>{{ trip?.notes || 'لا يوجد ملاحظات' }}</span></div>
                </div>
              </div>
              <button (click)="openChat()" class="action-btn-secondary mt-4 sm:mt-0"><i class="fas fa-comments"></i><span>تواصل مع السائق</span></button>
            </div>
          </div>

          <!-- Car Details Card -->
          <div class="card">
            <h3 class="card-title">تفاصيل السيارة</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="w-full h-56 bg-gray-200 rounded-lg overflow-hidden">
                <img [src]="trip?.carImagesUrl[0]" alt="Car" class="w-full h-full object-cover" *ngIf="trip?.carImagesUrl?.length">
              </div>
              <div class="space-y-4">
                <div class="detail-row"><span class="label">نوع السيارة:</span><span class="value">{{ trip?.carModel || 'غير محدد' }}</span></div>
                <div class="detail-row"><span class="label">لون السيارة:</span><span class="value">{{ trip?.carColor || 'غير محدد' }}</span></div>
                <div class="detail-row"><span class="label">رقم اللوحة:</span><span class="value">{{ trip?.carNumber || 'غير محدد' }}</span></div>
                <div class="detail-row"><span class="label">مقاعد متاحة:</span><span class="value">{{ trip?.seatsNumber || '0' }}</span></div>
              </div>
            </div>
          </div>

          <!-- START: TABS SECTION FOR DRIVER -->
          <div *ngIf="isCurrentUserDriver()" class="card !p-0 overflow-hidden">
            <!-- Tab Headers -->
            <div class="flex border-b border-gray-200">
              <button (click)="activeDriverTab = 'pending'" class="tab-btn" [class.active]="activeDriverTab === 'pending'">
                <i class="fas fa-clock"></i>
                <span>طلبات الحجز المعلقة</span>
                <span class="tab-badge bg-yellow-500">{{ pendingBookings.length }}</span>
              </button>
              <button (click)="activeDriverTab = 'confirmed'" class="tab-btn" [class.active]="activeDriverTab === 'confirmed'">
                <i class="fas fa-check-circle"></i>
                <span>الركاب المؤكدون</span>
                <span class="tab-badge bg-green-500">{{ confirmedPassengers.length }}</span>
              </button>
            </div>

            <!-- Tab Content -->
            <div class="p-6">
              <!-- Pending Bookings Panel -->
              <div *ngIf="activeDriverTab === 'pending'" class="space-y-4">
                <div *ngIf="pendingBookings.length > 0; else noPending">
                  <div *ngFor="let p of pendingBookings" class="list-item">
                    <div class="flex items-center gap-4">
                      <img [src]="p.passengerImageURL" alt="Passenger" class="w-12 h-12 rounded-full object-cover">
                      <div>
                        <div class="font-bold text-gray-800">{{ p.passengerName }}</div>
                        <div class="text-sm text-gray-500">{{ p.seatsBooked }} مقاعد - <span class="font-semibold">{{ p.price }} جنيه</span></div>
                      </div>
                    </div>
                    <div class="flex items-center gap-2">
                      <button (click)="acceptBooking(p.booking)" class="action-btn-sm bg-green-500 hover:bg-green-600">قبول</button>
                      <button (click)="cancelBookingByDriver(p.booking)" class="action-btn-sm bg-red-500 hover:bg-red-600">رفض</button>
                    </div>
                  </div>
                </div>
                <ng-template #noPending><p class="text-gray-500 text-center py-4">لا يوجد طلبات حجز معلقة حالياً.</p></ng-template>
              </div>

              <!-- Confirmed Passengers Panel -->
              <div *ngIf="activeDriverTab === 'confirmed'" class="space-y-4">
                <div *ngIf="confirmedPassengers.length > 0; else noConfirmed">
                  <div *ngFor="let p of confirmedPassengers" class="list-item">
                    <div class="flex items-center gap-4">
                      <img [src]="p.imageUrl" alt="Passenger" class="w-12 h-12 rounded-full object-cover">
                      <div class="font-bold text-gray-800">{{ p.name }}</div>
                    </div>
                    <div *ngIf="trip?.status === 2 || trip?.status === 3">
                      <button *ngIf="!p.hasBeenRated" (click)="openRatePassengerModal(p)" class="action-btn-sm bg-yellow-500 hover:bg-yellow-600">قيّم</button>
                      <span *ngIf="p.hasBeenRated" class="text-green-600 text-xs font-semibold">تم التقييم</span>
                    </div>
                  </div>
                </div>
                <ng-template #noConfirmed><p class="text-gray-500 text-center py-4">لا يوجد ركاب مؤكدون بعد.</p></ng-template>
              </div>
            </div>
          </div>
          <!-- END: TABS SECTION FOR DRIVER -->

        </div>

        <!-- Right Column (Sticky Actions) -->
        <div class="lg:col-span-1">
          <div class="sticky top-40 space-y-6">
            <div class="card">
              <div class="flex-col justify-between w-full">
      <div>
         <i class="fas fa-map-marker-alt rounded-full text-blue-600 p-1"></i>
        <span class="text-sm font-bold text-gray-700">نقطة الانطلاق</span>
        <p class="text-lg font-arabic text-gray-800">{{ trip?.departureCity || 'غير محدد' }}</p>
      </div>
      
      <div>
        <i class="fas fa-flag-checkered rounded-full text-green-600 p-1"></i>
        <span class="text-sm font-bold text-gray-700 ">الوجهة</span>
        <p class="text-lg font-arabic text-gray-800">{{ trip?.destinationCity || 'غير محدد' }}</p>
      </div>
    </div>
            </div>
            <div class="card">
              <!-- Driver Actions -->
              <div *ngIf="isCurrentUserDriver()" class="space-y-4">
                <h3 class="card-title text-center">إدارة الرحلة</h3>
                <button *ngIf="trip?.status === 1" (click)="confirmStartTrip()" class="action-btn bg-green-500 hover:bg-green-600"><i class="fas fa-play"></i>ابدأ الرحلة</button>
                <button *ngIf="trip?.status === 2" (click)="confirmCompleteTrip()" class="action-btn bg-[#364E99] hover:bg-blue-800"><i class="fas fa-check-circle"></i>أنهِ الرحلة</button>
                <div *ngIf="trip?.status === 1 || trip?.status === 2" class="grid grid-cols-2 gap-3">
                  <button (click)="openUpdateTripModal()" class="action-btn-secondary"><i class="fas fa-edit"></i>تعديل</button>
                  <button (click)="confirmDeleteTrip()" class="action-btn-secondary hover:bg-red-100 hover:text-red-600"><i class="fas fa-trash-alt"></i>إلغاء</button>
                </div>
              </div>
              <!-- Passenger Actions -->
              <div *ngIf="!isCurrentUserDriver()">
                <div *ngIf="userBookingStatus; else noBookingBlock">
                  <div class="text-center p-4 rounded-lg bg-gray-100">
                    <div class="font-bold text-gray-800 mb-1">حالة حجزك</div>
                    <div class="text-lg font-bold" [ngClass]="{'text-yellow-600': userBookingStatus.status === 'قيد الانتظار', 'text-green-600': userBookingStatus.status === 'مؤكد', 'text-red-600': userBookingStatus.status === 'ملغي'}">{{ userBookingStatus.status }}</div>
                  </div>
                  <button *ngIf="userBookingStatus.status === 'قيد الانتظار' || userBookingStatus.status === 'مؤكد'" (click)="confirmCancelBookingAsPassenger(userBookingStatus.bookingId)" class="action-btn bg-red-600 hover:bg-red-700 mt-4"><i class="fas fa-times-circle"></i>إلغاء الحجز</button>
                </div>
                <ng-template #noBookingBlock>
                  <div *ngIf="trip?.status === 1; else tripNotBookable">
                    <div class="text-center mb-4"><span class="text-3xl font-extrabold text-[#364E99]">{{ trip?.seatPrice }}</span><span class="text-gray-600"> جنيه للمقعد</span></div>
                    <button (click)="openModal()" class="action-btn bg-[#364E99] hover:bg-blue-800"><i class="fas fa-ticket-alt"></i>احجز مقعدك الآن</button>
                  </div>
                  <ng-template #tripNotBookable><div class="info-box">لا يمكن حجز هذه الرحلة حالياً.</div></ng-template>
                </ng-template>
                <div *ngIf="isConfirmedPassenger && trip?.status === 3" class="mt-4">
                  <button *ngIf="!hasRatedDriver" (click)="openRateDriverModal()" class="action-btn bg-yellow-500 hover:bg-yellow-600"><i class="fas fa-star"></i>قيّم السائق</button>
                  <div *ngIf="hasRatedDriver" class="info-box bg-green-100 text-green-700">شكراً لك، تم تقييم السائق.</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modals and Loading Template -->
<ng-template #loadingTemplate>
  <div class="flex justify-center items-center h-screen bg-[#f4f7fc]">
    <div class="text-center">
      <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-[#364E99]"></div>
      <div class="text-2xl font-bold text-gray-600 mt-6">...جاري تحميل تفاصيل الرحلة</div>
    </div>
  </div>
</ng-template>

<div *ngIf="showModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4" (click)="closeModal()">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto" (click)="$event.stopPropagation()">
    <div class="flex justify-between items-center p-5 border-b border-gray-200">
      <h3 class="text-xl font-bold text-gray-800">طلب حجز مقعد</h3>
      <button (click)="closeModal()" class="text-gray-400 hover:text-gray-600 p-1"><i class="fas fa-times text-xl"></i></button>
    </div>
    <div class="p-6 space-y-6">
      <div>
        <label for="seats" class="block text-sm font-medium text-gray-700 mb-2">عدد المقاعد:</label>
        <select id="seats" [(ngModel)]="modalSeats" (ngModelChange)="updateTotalPrice()" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          <option *ngFor="let seat of availableSeatsArray" [value]="seat">{{ seat }}</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">السعر الإجمالي:</label>
        <div class="w-full p-3 border border-gray-200 bg-gray-50 rounded-lg text-center">
          <span class="text-2xl font-bold text-gray-800">{{ totalPrice | number }}</span>
          <span class="text-sm text-gray-500 ml-1">جنيه</span>
        </div>
      </div>
      <div class="relative flex items-start pt-2">
        <div class="flex items-center h-5">
          <input id="suggest-price-toggle" type="checkbox" [(ngModel)]="isSuggestingPrice" (ngModelChange)="updateTotalPrice()" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer">
        </div>
        <div class="ml-3 text-sm">
          <label for="suggest-price-toggle" class="font-medium text-gray-700 cursor-pointer">أرغب في اقتراح سعر آخر</label>
        </div>
      </div>
      <div *ngIf="isSuggestingPrice" class="transition-all duration-300">
        <label for="suggested-price" class="block text-sm font-medium text-gray-700 mb-2">السعر المقترح للمقعد الواحد:</label>
        <input id="suggested-price" type="number" [(ngModel)]="suggestedPrice" (ngModelChange)="updateTotalPrice()" placeholder="ادخل السعر الذي تقترحه" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" min="1">
      </div>
    </div>
    <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 rounded-b-2xl">
      <button (click)="confirmBooking()" class="w-full text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4" [ngClass]="{'bg-orange-500 hover:bg-orange-600 focus:ring-orange-300': isSuggestingPrice, 'bg-[#364E99] hover:bg-blue-800 focus:ring-blue-300': !isSuggestingPrice}">
        {{ isSuggestingPrice ? 'إرسال العرض' : 'تأكيد الحجز' }}
      </button>
    </div>
  </div>
</div>

<div *ngIf="showRatingModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60" (click)="closeRatingModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 class="text-xl font-semibold text-gray-800">تقييم {{ ratingData.targetName }}</h3>
      <button (click)="closeRatingModal()" type="button" class="modal-close-btn text-2xl leading-none">&times;</button>
    </div>
    <div class="p-6 space-y-6">
      <div>
        <label class="block mb-4 text-lg font-medium text-gray-900 text-center">تقييمك</label>
        <div class="flex items-center justify-center space-x-2" dir="ltr">
          <ng-container *ngFor="let i of [5, 4, 3, 2, 1]">
            <button (click)="ratingData.rating = i" class="star-3d" [ngClass]="{'toggled': ratingData.rating >= i}">★</button>
          </ng-container>
        </div>
      </div>
      <div>
        <label for="comment" class="modal-label">أضف تعليقاً (اختياري)</label>
        <textarea id="comment" [(ngModel)]="ratingData.comment" name="comment" rows="4" class="modal-input" placeholder="اكتب تعليقك هنا..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button (click)="closeRatingModal()" type="button" class="action-btn-secondary">إلغاء</button>
      <button (click)="submitRating()" [disabled]="isSubmittingRating" type="button" class="action-btn bg-[#364E99] hover:bg-blue-800 disabled:opacity-50">
        {{ isSubmittingRating ? 'جاري الإرسال...' : 'إرسال التقييم' }}
      </button>
    </div>
  </div>
</div>
