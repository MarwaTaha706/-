
<div *ngIf="!isLoading; else loadingTemplate">

  <div class="bg-[#f4f7fc] min-h-screen font-arabic p-4 sm:p-6 lg:p-8">
    <div class="max-w-7xl mx-auto">

      <header class="bg-white shadow-lg rounded-2xl p-6 mb-6 mt-6 flex flex-col sm:flex-row justify-between items-center gap-4">
        <div class="flex items-center gap-4">
          <div class="bg-[#364E99] text-white p-3 rounded-xl shadow-sm">
            <i class="fa-solid fa-route text-2xl"></i>
          </div>
          <div>
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">{{ pageTitle }}</h1>
            <p class="text-sm text-gray-500 mt-1">املأ التفاصيل أدناه لإنشاء رحلتك الجديدة</p>
          </div>
        </div>
        <button (click)="onCancel()" class="action-btn-secondary w-full sm:w-auto">
          <i class="fas fa-arrow-left"></i>
          <span>العودة إلى رحلاتي</span>
        </button>
      </header>

      <!-- Main Grid Layout -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Left Column (Form) -->
        <div class="lg:col-span-2">
          <div class="card">
            <h3 class="card-title">تفاصيل الرحلة المقترحة</h3>
            <form (ngSubmit)="onSubmit()" #tripForm="ngForm" class="space-y-6">
              
        
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="form-group">
                  <label for="from"><i class="fas fa-map-marker-alt"></i> من</label>
                  <input type="text" id="from" name="from" placeholder="حدد على الخريطة أو ابحث بالاسم" required [(ngModel)]="tripDetails.from" (input)="onAddressInput('from', $event)">
                </div>
                <div class="form-group">
                  <label for="to"><i class="fas fa-flag-checkered"></i> إلى</label>
                  <input type="text" id="to" name="to" placeholder="حدد على الخريطة أو ابحث بالاسم" required [(ngModel)]="tripDetails.to" (input)="onAddressInput('to', $event)">
                </div>
              </div>

              <div class="form-group">
                <label for="dateTime"><i class="fas fa-calendar-alt"></i> تاريخ ووقت الرحلة</label>
                <input type="datetime-local" id="dateTime" name="dateTime" required [(ngModel)]="tripDetails.dateTime">
              </div>

           
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="form-group">
                  <label for="passengers"><i class="fas fa-users"></i> عدد الركاب</label>
                  <input type="number" id="passengers" name="passengers" min="1" max="10" required [(ngModel)]="tripDetails.passengers">
                </div>
                <div class="form-group">
                  <label for="price"><i class="fas fa-dollar-sign"></i> سعر الرحلة (جنيه)</label>
                  <input type="number" id="price" name="price" min="0" placeholder="50" required [(ngModel)]="tripDetails.price">
                </div>
              </div>

              <div class="form-group">
                <label for="notes"><i class="fas fa-comment-dots"></i> ملاحظات (اختياري)</label>
                <textarea id="notes" name="notes" rows="3" placeholder="مثال: أفضل التحرك صباحًا، لا أقبل التدخين..." [(ngModel)]="tripDetails.notes"></textarea>
              </div>

          
              <div class="pt-4 border-t border-gray-200">
                <button type="submit" class="action-btn bg-[#364E99] hover:bg-[#1f2c6b]" [disabled]="!tripForm.form.valid || isSubmitting">
                  <span *ngIf="!isSubmitting"><i class="fas fa-plus-circle"></i> {{ buttonText }}</span>
                  <span *ngIf="isSubmitting" class="flex items-center justify-center gap-2">
                    <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                    جاري الحفظ...
                  </span>
                </button>
              </div>
            </form>
          </div>
        </div>

        <div class="lg:col-span-1">
          <div class="sticky top-24 space-y-6">
            <div class="card">
              <h3 class="card-title">تحديد المسار على الخريطة</h3>
              <div class="map-section-wrapper rounded-lg overflow-hidden relative h-[400px] border">
                <div id="popup-map" class="w-full h-full"></div>
              </div>
              <div class="map-controls-overlay mt-4 space-y-2">
                <button (click)="selectOnMap('from')" class="control-btn" [class.active]="activeField === 'from'">
                  <i class="fas fa-map-pin"></i> اختر نقطة الانطلاق
                </button>
                <button (click)="selectOnMap('to')" class="control-btn" [class.active]="activeField === 'to'">
                  <i class="fas fa-flag"></i> اختر نقطة الوصول
                </button>
                <div class="grid grid-cols-2 gap-2 pt-2">
                  <button (click)="locateUser()" class="control-btn-sm">
                    <i class="fas fa-crosshairs"></i> موقعي
                  </button>
                  <button (click)="resetMap()" class="control-btn-sm reset">
                    <i class="fas fa-undo"></i> إعادة
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #loadingTemplate>
  <div class="flex justify-center items-center h-screen bg-[#f4f7fc]">
    <div class="text-center">
      <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-[#364E99]"></div>
      <div class="text-2xl font-bold text-gray-600 mt-6">...جاري تحميل الصفحة</div>
    </div>
  </div>
</ng-template>
